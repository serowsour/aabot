<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONYX TITAN | Professional ModView</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-black: #0e0e10;
            --bg-light: #18181b;
            --bg-panel: #1f1f23;
            --twitch-purple: #9147ff;
            --border-color: #303032;
            --text-main: #efeff1;
            --text-muted: #adadb8;
        }

        body {
            background-color: var(--bg-black);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Layout Grid simile alla ModView di Twitch */
        .modview-grid {
            display: grid;
            grid-template-columns: 50px 1fr 340px;
            grid-template-rows: 50px 1fr 300px;
            height: 100vh;
        }

        .top-bar { grid-column: 1 / -1; background: var(--bg-light); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; z-index: 100; }
        .side-nav { grid-column: 1; background: var(--bg-light); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; align-items: center; padding-top: 10px; gap: 20px; }
        
        /* Pannelli Rettangolari */
        .panel { background: var(--bg-panel); border: 1px solid var(--border-color); display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .panel-header { background: var(--bg-light); padding: 8px 12px; font-weight: 600; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        
        .main-stream { grid-column: 2; grid-row: 2; margin: 5px; }
        .chat-section { grid-column: 3; grid-row: 2 / 4; margin: 5px; margin-left: 0; }
        .mod-actions { grid-column: 2; grid-row: 3; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin: 5px; margin-top: 0; }

        /* Chat Styling */
        #chat-container { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; display: flex; flex-direction: column; gap: 6px; }
        .chat-line { position: relative; padding: 4px 8px; border-radius: 2px; }
        .chat-line:hover { background: rgba(255,255,255,0.05); }
        .chat-line .tools { display: none; position: absolute; right: 5px; top: 5px; background: var(--bg-light); border: 1px solid var(--border-color); padding: 2px; gap: 4px; z-index: 50; }
        .chat-line:hover .tools { display: flex; }

        /* Buttons */
        .action-btn { background: #35353b; color: white; border-radius: 4px; padding: 8px; font-size: 12px; font-weight: 600; text-align: left; transition: 0.2s; }
        .action-btn:hover { background: #464649; }
        .btn-purple { background: var(--twitch-purple); }
        .btn-purple:hover { background: #772ce8; }
        .btn-danger { color: #ff4a4a; border: 1px solid #ff4a4a; background: transparent; }
        .btn-danger:hover { background: #ff4a4a; color: white; }

        /* Inputs */
        .chat-input-area { padding: 10px; background: var(--bg-light); border-top: 1px solid var(--border-color); }
        .twitch-input { width: 100%; background: #0e0e10; border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; color: white; outline: none; font-size: 13px; }
        .twitch-input:focus { border-color: var(--twitch-purple); }

        /* Overlays */
        #login-overlay { position: fixed; inset: 0; background: var(--bg-black); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .hidden { display: none !important; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background: #00f593; box-shadow: 0 0 10px #00f593; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #39393d; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="p-10 border border-[#303032] bg-[#18181b] rounded-lg text-center shadow-2xl max-w-md">
            <div class="mb-6 flex justify-center">
                <div class="w-12 h-12 bg-[#9147ff] rounded-lg flex items-center justify-center shadow-lg">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"/></svg>
                </div>
            </div>
            <h1 class="text-2xl font-bold mb-2">SerowMOD Titan</h1>
            <p class="text-gray-400 text-sm mb-8">Professional Moderation Interface</p>
            <button onclick="Core.login()" class="w-full bg-[#9147ff] hover:bg-[#772ce8] text-white py-3 rounded font-bold transition">CONNETTI TWITCH</button>
            <div id="auth-info" class="mt-4 text-[10px] font-mono text-gray-600">Checking redirect state...</div>
        </div>
    </div>

    <div id="main-view" class="modview-grid hidden">
        
        <header class="top-bar">
            <div class="flex items-center gap-4">
                <span class="font-bold text-sm tracking-tighter">TITAN <span class="text-[#9147ff]">VIEW</span></span>
                <div class="h-4 w-px bg-zinc-700"></div>
                <div class="text-xs text-zinc-400">Canale: <span id="display-channel" class="text-white font-bold">---</span></div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-xs flex items-center"><span class="status-dot dot-green"></span> SESSIONE ATTIVA</div>
                <img id="user-pfp" src="" class="w-7 h-7 rounded border border-zinc-700">
                <button onclick="location.reload()" class="text-zinc-500 hover:text-white">‚úï</button>
            </div>
        </header>

        <nav class="side-nav">
            <div class="p-2 bg-[#9147ff] rounded cursor-pointer">üõ°Ô∏è</div>
            <div class="p-2 text-zinc-500 hover:text-white cursor-pointer">üìä</div>
            <div class="p-2 text-zinc-500 hover:text-white cursor-pointer">üí¨</div>
            <div class="mt-auto mb-4 p-2 text-zinc-500 hover:text-white cursor-pointer">‚öôÔ∏è</div>
        </nav>

        <section class="panel main-stream">
            <div class="panel-header">
                <span>STREAM</span>
                <span class="text-[10px] text-zinc-500">LIVE PLAYER</span>
            </div>
            <div id="video-root" class="flex-1 bg-black"></div>
        </section>

        <div class="mod-actions">
            <div class="panel">
                <div class="panel-header">AZIONI RAPIDE</div>
                <div class="p-3 grid grid-cols-2 gap-2 overflow-y-auto">
                    <button onclick="Bot.say('/clear')" class="action-btn">üóëÔ∏è Clear Chat</button>
                    <button onclick="Bot.say('/subsonly')" class="action-btn">üíé Subs Only</button>
                    <button onclick="Bot.say('/emoteonly')" class="action-btn">üòä Emote Only</button>
                    <button onclick="Bot.say('/slow 10')" class="action-btn">üê¢ Slow 10s</button>
                    <button onclick="Bot.say('/followers 10')" class="action-btn">üë• Follow 10m</button>
                    <button onclick="Bot.say('/uniquechat')" class="action-btn">üö´ No Spam</button>
                </div>
            </div>
            <div class="panel border-red-900/30">
                <div class="panel-header text-red-500">MODALIT√Ä SCUDO</div>
                <div class="p-4 flex flex-col justify-center h-full gap-4">
                    <div class="bg-red-500/10 border border-red-500/20 p-3 rounded text-[11px] text-red-200">
                        Attiva restrizioni massime istantanee per contrastare raid o spam pesante.
                    </div>
                    <button onclick="Core.toggleShield()" id="shield-btn" class="w-full py-4 rounded font-extrabold text-sm border-2 border-red-600 text-red-600 hover:bg-red-600 hover:text-white transition">
                        ATTIVA PROTOCOLLO SCUDO
                    </button>
                </div>
            </div>
        </div>

        <section class="panel chat-section">
            <div class="panel-header">
                <span>CHAT</span>
                <span id="chat-count" class="text-[10px] text-[#9147ff]">CONNESSA</span>
            </div>
            <div id="chat-container"></div>
            <div class="chat-input-area">
                <div class="text-[10px] text-zinc-500 mb-1 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    Visibile solo ai moderatori
                </div>
                <input type="text" id="chat-input" class="twitch-input" placeholder="Invia un messaggio...">
            </div>
        </section>

    </div>

    <script>
        /**
         * CORE LOGIC - TITAN ENGINE
         */
        const Core = {
            config: {
                clientId: 'uqf5d6at2fnet8w5tylz17l2sb4onx',
                // Redirect intelligente
                redirectUri: window.location.origin + window.location.pathname,
                scopes: [
                    'chat:read', 'chat:edit', 
                    'channel:moderate', 
                    'moderator:manage:chat_settings',
                    'moderator:manage:banned_users',
                    'user:read:email'
                ].join(' ')
            },
            state: {
                token: null,
                user: null,
                channel: null,
                isShield: false
            },

            init() {
                const hash = window.location.hash;
                if (hash.includes('access_token')) {
                    const params = new URLSearchParams(hash.substring(1));
                    this.state.token = params.get('access_token');
                    window.history.pushState({}, document.title, window.location.pathname);
                    this.bootstrap();
                }
            },

            login() {
                const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${this.config.clientId}&redirect_uri=${encodeURIComponent(this.config.redirectUri)}&response_type=token&scope=${encodeURIComponent(this.config.scopes)}`;
                window.location.href = authUrl;
            },

            async bootstrap() {
                document.getElementById('auth-info').innerText = "Validazione credenziali...";
                try {
                    const resp = await fetch('https://api.twitch.tv/helix/users', {
                        headers: { 'Authorization': `Bearer ${this.state.token}`, 'Client-ID': this.config.clientId }
                    });
                    const data = await resp.json();
                    this.state.user = data.data[0];

                    const target = prompt("Canale da monitorare (es: serowsour):");
                    if (target) {
                        this.state.channel = target.toLowerCase().trim();
                        this.launchUI();
                    }
                } catch (e) {
                    alert("Errore critico Auth: " + e.message);
                }
            },

            launchUI() {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('user-pfp').src = this.state.user.profile_image_url;
                document.getElementById('display-channel').innerText = this.state.channel.toUpperCase();
                
                // Embed Stream
                const parent = window.location.hostname;
                document.getElementById('video-root').innerHTML = `
                    <iframe src="https://player.twitch.tv/?channel=${this.state.channel}&parent=${parent}&autoplay=true" height="100%" width="100%" allowfullscreen></iframe>
                `;

                Bot.init();
            },

            toggleShield() {
                this.state.isShield = !this.state.isShield;
                const btn = document.getElementById('shield-btn');
                if (this.state.isShield) {
                    Bot.say('/subsonly');
                    Bot.say('/emoteonly');
                    Bot.say('/slow 30');
                    Bot.say('/clear');
                    btn.classList.add('bg-red-600', 'text-white');
                    btn.innerText = "SCUDO ATTIVO - DISATTIVA";
                } else {
                    Bot.say('/subsonlyoff');
                    Bot.say('/emoteonlyoff');
                    Bot.say('/slowoff');
                    btn.classList.remove('bg-red-600', 'text-white');
                    btn.innerText = "ATTIVA PROTOCOLLO SCUDO";
                }
            }
        };

        const Bot = {
            client: null,

            init() {
                this.client = new tmi.Client({
                    options: { debug: false },
                    identity: {
                        username: Core.state.user.login,
                        password: `oauth:${Core.state.token}`
                    },
                    channels: [Core.state.channel]
                });

                this.client.connect().catch(console.error);
                this.events();
                this.setupInput();
            },

            events() {
                this.client.on('message', (chan, tags, msg, self) => {
                    this.renderMessage(tags, msg);
                });
            },

            renderMessage(tags, msg) {
                const container = document.getElementById('chat-container');
                const line = document.createElement('div');
                line.className = 'chat-line';
                
                const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const color = tags.color || '#9147ff';
                const isMod = tags.mod || tags.badges?.broadcaster === '1';

                line.innerHTML = `
                    <div class="tools">
                        <button onclick="Bot.say('/delete ${tags.id}')" class="text-[10px] bg-red-900/50 p-1 rounded">DEL</button>
                        <button onclick="Bot.say('/timeout ${tags.username} 600')" class="text-[10px] bg-zinc-700 p-1 rounded">10m</button>
                        <button onclick="Bot.say('/ban ${tags.username}')" class="text-[10px] bg-black p-1 rounded">BAN</button>
                    </div>
                    <span class="text-zinc-600 text-[10px] mono mr-1">${time}</span>
                    ${isMod ? '<span class="text-[#00f593] font-bold mr-1">üõ°Ô∏è</span>' : ''}
                    <span style="color:${color}" class="font-bold cursor-pointer">${tags['display-name']}</span>: 
                    <span class="text-zinc-100">${msg}</span>
                `;

                container.appendChild(line);
                container.scrollTop = container.scrollHeight;
            },

            setupInput() {
                const input = document.getElementById('chat-input');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && input.value) {
                        this.say(input.value);
                        input.value = '';
                    }
                });
            },

            say(msg) {
                if (this.client) this.client.say(Core.state.channel, msg);
            }
        };

        window.onload = () => Core.init();
    </script>
</body>
</html>
