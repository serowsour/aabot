<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProMod Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <style>
        /* Stile Scrollbar "Invisibile" ma funzionale */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #18181b; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #71717a; }
        body { background-color: #09090b; color: #e4e4e7; }
        .btn-action { transition: all 0.1s; }
        .btn-action:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen w-screen flex flex-col overflow-hidden font-sans">

    <header class="h-12 bg-[#18181b] border-b border-[#27272a] flex items-center justify-between px-4">
        <div class="flex items-center gap-3">
            <div id="status-dot" class="w-3 h-3 rounded-full bg-red-600 shadow-[0_0_8px_rgba(220,38,38,0.5)]"></div>
            <h1 class="font-bold text-lg tracking-tight text-purple-500">PRO<span class="text-white">MOD</span> PANEL</h1>
        </div>
        <div class="flex gap-2">
            <span id="debug-msg" class="text-xs text-gray-500 font-mono self-center mr-4">In attesa di login...</span>
            <button id="login-btn" onclick="startLogin()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded text-sm font-bold shadow-lg shadow-purple-900/20 transition-all">
                CONNETTI TWITCH
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <div class="flex-1 flex flex-col border-r border-[#27272a] bg-black">
            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-1 text-sm font-medium">
                <div class="text-gray-600 italic text-center mt-20">
                    Clicca "Connetti Twitch" per caricare la chat.
                </div>
            </div>
            <div class="p-3 bg-[#18181b] border-t border-[#27272a]">
                <input type="text" id="chat-input" placeholder="Scrivi un messaggio o un comando..." 
                    class="w-full bg-[#27272a] text-white border border-[#3f3f46] rounded p-2 text-sm focus:outline-none focus:border-purple-500 transition-colors">
            </div>
        </div>

        <div class="w-80 bg-[#18181b] flex flex-col overflow-y-auto">
            
            <div class="p-4 border-b border-[#27272a]">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Controllo Folla</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="send('/clear')" class="btn-action bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs font-bold border border-slate-700">üßπ CLEAR CHAT</button>
                    <button onclick="send('/slow 10')" class="btn-action bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs font-bold border border-slate-700">üê¢ SLOW 10s</button>
                    <button onclick="send('/emoteonly')" class="btn-action bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs font-bold border border-slate-700">üòä EMOTE ONLY</button>
                    <button onclick="send('/followers 10m')" class="btn-action bg-slate-800 hover:bg-slate-700 p-2 rounded text-xs font-bold border border-slate-700">üë• FOLLOW 10m</button>
                </div>
            </div>

            <div class="p-4 border-b border-[#27272a] bg-red-900/10">
                <h3 class="text-xs font-bold text-red-500 uppercase tracking-widest mb-3">‚õî EMERGENCY</h3>
                <button onclick="toggleShield()" id="btn-shield" class="w-full btn-action bg-red-600 hover:bg-red-500 text-white p-4 rounded font-bold shadow-lg shadow-red-900/30 border border-red-500 flex flex-col items-center gap-1">
                    <span class="text-lg">ATTIVA SHIELD</span>
                    <span class="text-[10px] opacity-80 font-normal">Sub-only + Slow + Clear</span>
                </button>
                <button onclick="disableShield()" class="w-full mt-2 btn-action bg-green-700 hover:bg-green-600 text-white p-2 rounded text-xs font-bold border border-green-500">
                    DISATTIVA E RIPRISTINA
                </button>
            </div>

            <div class="p-4 flex-1">
                <h3 class="text-xs font-bold text-purple-400 uppercase tracking-widest mb-3">Comandi Bot</h3>
                <div id="cmd-list" class="space-y-2 text-xs"></div>
                <div class="mt-4 p-3 bg-[#27272a] rounded border border-[#3f3f46]">
                    <p class="text-[10px] text-gray-400 mb-1">Aggiungi nuovo comando:</p>
                    <code class="text-green-400 text-[10px]">!add !social Seguimi su IG!</code>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE ---
        const CLIENT_ID = 'uqf5d6at2fnet8w5tylz17l2sb4onx'; 
        const REDIRECT_URI = 'https://serowsour.github.io/aabot/'; 
        
        // --- VARIABILI ---
        let client;
        let savedCmds = JSON.parse(localStorage.getItem('proMod_cmds')) || {};

        // --- SISTEMA DI LOGIN ---
        function startLogin() {
            log("Avvio login...");
            const scope = 'chat:read chat:edit channel:moderate';
            const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(scope)}`;
            window.location.href = authUrl;
        }

        // Controllo al caricamento della pagina
        window.onload = () => {
            const hash = window.location.hash;
            if (hash.includes('access_token')) {
                const token = new URLSearchParams(hash.substring(1)).get('access_token');
                if (token) {
                    // Puliamo l'URL per estetica
                    window.history.pushState({}, document.title, window.location.pathname);
                    const channel = prompt("Inserisci il nome del canale (tutto minuscolo):");
                    if (channel) connectBot(token, channel.toLowerCase());
                }
            } else {
                // Controllo se l'URI corrente corrisponde a quello impostato
                if(window.location.href !== REDIRECT_URI && !window.location.href.includes('127.0.0.1')) {
                   // log("‚ö†Ô∏è ATTENZIONE: L'URL nella barra non corrisponde esattamente al Redirect URI.");
                }
            }
            renderCmds();
        };

        // --- CONNESSIONE TMI.JS ---
        function connectBot(token, channel) {
            log(`Connessione a ${channel}...`);
            
            client = new tmi.Client({
                options: { debug: true },
                connection: { secure: true, reconnect: true },
                identity: { username: channel, password: `oauth:${token}` },
                channels: [channel]
            });

            client.connect()
                .then(() => {
                    document.getElementById('status-dot').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                    document.getElementById('login-btn').innerText = `CONNESSO: ${channel.toUpperCase()}`;
                    document.getElementById('login-btn').classList.add('bg-gray-700', 'cursor-default');
                    document.getElementById('chat-box').innerHTML = ''; // Pulisce il messaggio di benvenuto
                    addSystemMsg(`‚úÖ Connesso con successo al canale ${channel}.`);
                })
                .catch(err => {
                    log("ERRORE CONNESSIONE: " + err);
                    alert("Impossibile connettersi. Controlla la console (F12) per i dettagli.");
                });

            // GESTIONE MESSAGGI
            client.on('message', (chan, tags, message, self) => {
                if (self) return;

                // Renderizza il messaggio
                renderMessage(tags, message);

                // Gestione Comandi (!add, ecc.)
                handleCommands(chan, tags, message);
            });
        }

        // --- FUNZIONI CHAT & UI ---
        function renderMessage(tags, msg) {
            const chat = document.getElementById('chat-box');
            const div = document.createElement('div');
            const color = tags.color || '#a855f7'; // Colore default viola
            
            div.className = "hover:bg-[#18181b] px-2 py-1 -mx-2 rounded cursor-pointer group";
            div.innerHTML = `
                <span class="text-[10px] text-gray-500 mr-1">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                <span style="color:${color}" class="font-bold cursor-pointer hover:underline" onclick="pasteUser('${tags.username}')">${tags['display-name']}</span>: 
                <span class="text-gray-300 group-hover:text-white transition-colors">${msg}</span>
            `;
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function addSystemMsg(msg) {
            const chat = document.getElementById('chat-box');
            chat.innerHTML += `<div class="px-2 py-1 text-xs text-yellow-500 font-mono border-l-2 border-yellow-600 bg-yellow-900/10 mb-1">${msg}</div>`;
            chat.scrollTop = chat.scrollHeight;
        }

        function pasteUser(user) {
            const input = document.getElementById('chat-input');
            input.value = `@${user} ` + input.value;
            input.focus();
        }

        // --- LOGICA BOT ---
        function handleCommands(chan, tags, msg) {
            const args = msg.split(' ');
            const cmd = args[0].toLowerCase();
            const isMod = tags.mod || tags.badges?.broadcaster;

            // 1. Aggiungi comando (!add !ciao Risposta)
            if (cmd === '!add' && isMod) {
                if (args[1] && args[2]) {
                    const newCmdName = args[1].startsWith('!') ? args[1] : '!' + args[1];
                    const response = args.slice(2).join(' ');
                    savedCmds[newCmdName] = response;
                    localStorage.setItem('proMod_cmds', JSON.stringify(savedCmds));
                    renderCmds();
                    client.say(chan, `üíæ Comando ${newCmdName} salvato.`);
                }
            }

            // 2. Esegui comando salvato
            if (savedCmds[cmd]) {
                client.say(chan, savedCmds[cmd]);
            }
        }

        function renderCmds() {
            const list = document.getElementById('cmd-list');
            list.innerHTML = Object.keys(savedCmds).map(k => `
                <div class="flex justify-between items-center bg-[#18181b] p-2 rounded border border-[#27272a] group hover:border-purple-500 transition-colors">
                    <span class="font-bold text-gray-300">${k}</span>
                    <button onclick="delCmd('${k}')" class="text-red-500 opacity-0 group-hover:opacity-100 font-bold px-2 hover:bg-red-900/30 rounded">‚úï</button>
                </div>
            `).join('');
        }

        function delCmd(k) {
            delete savedCmds[k];
            localStorage.setItem('proMod_cmds', JSON.stringify(savedCmds));
            renderCmds();
        }

        // --- AZIONI MODERATORE ---
        function send(cmd) {
            if (client) client.say(client.getChannels()[0], cmd);
            else alert("Non sei connesso!");
        }

        function toggleShield() {
            if (!client) return;
            const chan = client.getChannels()[0];
            // Sequenza di protezione
            client.say(chan, '/clear');
            client.say(chan, '/subsonly');
            client.say(chan, '/slow 20');
            client.say(chan, '/followers 30m'); // Follower da almeno 30 min
            
            const btn = document.getElementById('btn-shield');
            btn.classList.replace('bg-red-600', 'bg-white');
            btn.classList.replace('text-white', 'text-red-600');
            btn.querySelector('span').innerText = "SHIELD ATTIVO";
            addSystemMsg("üõ°Ô∏è SHIELD MODE ATTIVATA: Chat bloccata.");
        }

        function disableShield() {
            if (!client) return;
            const chan = client.getChannels()[0];
            client.say(chan, '/subsonlyoff');
            client.say(chan, '/slowoff');
            client.say(chan, '/followersoff');
            
            const btn = document.getElementById('btn-shield');
            btn.classList.replace('bg-white', 'bg-red-600');
            btn.classList.replace('text-red-600', 'text-white');
            btn.querySelector('span').innerText = "ATTIVA SHIELD";
            addSystemMsg("‚úÖ Allarme rientrato. Chat sbloccata.");
        }

        // Gestione Input Chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && client) {
                client.say(client.getChannels()[0], e.target.value);
                e.target.value = '';
            }
        });

        function log(txt) {
            document.getElementById('debug-msg').innerText = txt;
            console.log(txt);
        }
    </script>
</body>
</html>
