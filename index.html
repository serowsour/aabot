<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Win10 Pro Mod Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #000; user-select: none; }
        .win-10-bg { background-color: #1f1f1f; }
        .win-10-sidebar { background-color: #2b2b2b; }
        .win-10-chat { background-color: #111; border: 1px solid #333; }
        .win-10-btn { background-color: #333; transition: 0.2s; border: 1px solid #444; }
        .win-10-btn:hover { background-color: #444; border-color: #666; }
        .mod-btn { opacity: 0; transition: opacity 0.2s; }
        .chat-row:hover .mod-btn { opacity: 1; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #444; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-white overflow-hidden">

    <header class="h-10 win-10-bg border-b border-[#333] flex justify-between items-center px-4 z-50">
        <div class="flex items-center gap-4">
            <span class="text-xs font-bold tracking-widest text-purple-500">MODERATOR OS v2.0</span>
            <div id="account-area" class="hidden flex items-center gap-3 border-l border-white/10 pl-4">
                <img id="acc-pic" src="" class="w-6 h-6 rounded-full border border-purple-500">
                <span id="acc-name" class="text-xs font-semibold"></span>
                <button onclick="logout()" class="text-[10px] text-gray-400 hover:text-red-500 uppercase font-bold">Esci</button>
            </div>
        </div>
        <div class="flex h-full items-center">
            <div id="status-led" class="w-2 h-2 rounded-full bg-red-600 mr-2"></div>
            <span id="status-text" class="text-[10px] text-gray-500 font-bold uppercase">Sconnesso</span>
        </div>
    </header>

    <main class="flex-1 flex p-2 gap-2 bg-black overflow-hidden">
        
        <aside class="w-16 win-10-sidebar flex flex-col items-center py-4 gap-6 border border-[#333]">
            <button title="Dashboard" class="text-xl opacity-100">üè†</button>
            <button onclick="toggleShield()" title="Shield Mode" class="text-xl grayscale hover:grayscale-0">üõ°Ô∏è</button>
            <div class="flex-1"></div>
            <button onclick="location.reload()" title="Refresh" class="text-xl">üîÑ</button>
        </aside>

        <div class="flex-1 flex flex-col gap-2">
            <div id="live-player" class="bg-black win-10-chat aspect-video hidden">
                <div id="twitch-embed" class="w-full h-full"></div>
            </div>

            <div class="flex-1 win-10-chat flex flex-col overflow-hidden relative">
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 text-sm">
                    <div id="welcome-msg" class="h-full flex items-center justify-center text-gray-600 italic">
                        Effettua il login per attivare la console di moderazione.
                    </div>
                </div>
                <div class="p-2 bg-[#1f1f1f] border-t border-[#333]">
                    <input type="text" id="chat-input" placeholder="Invia un messaggio..." class="w-full bg-[#111] border border-[#333] p-2 text-sm focus:outline-none focus:border-purple-500">
                </div>
            </div>
        </div>

        <div id="mod-tools" class="w-72 flex flex-col gap-2 hidden">
            <div class="win-10-bg border border-[#333] p-4">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-4 tracking-widest">Azioni Rapide</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="modAction('/clear')" class="win-10-btn p-2 text-[10px] font-bold">CLEAR</button>
                    <button onclick="modAction('/subsonly')" class="win-10-btn p-2 text-[10px] font-bold">SUBS ONLY</button>
                    <button onclick="modAction('/emoteonly')" class="win-10-btn p-2 text-[10px] font-bold">EMOTE ONLY</button>
                    <button onclick="modAction('/slow 5')" class="win-10-btn p-2 text-[10px] font-bold">SLOW 5s</button>
                </div>
            </div>

            <div class="win-10-bg border border-[#333] p-4 flex-1 flex flex-col overflow-hidden">
                <h3 class="text-[10px] font-bold text-purple-500 uppercase mb-4 tracking-widest">Custom Bot</h3>
                <div id="bot-list" class="flex-1 overflow-y-auto space-y-2 mb-4"></div>
                <div class="text-[9px] text-gray-500 italic bg-black/30 p-2">
                    Usa !add !comando testo in chat per aggiungere risposte.
                </div>
            </div>
        </div>

        <div id="login-modal" class="absolute inset-0 bg-black/90 flex items-center justify-center z-[100]">
            <div class="bg-[#1f1f1f] border border-[#333] p-10 text-center shadow-2xl">
                <h1 class="text-3xl font-light mb-8">Moderator<span class="text-purple-500 font-bold">OS</span></h1>
                <button onclick="login()" class="bg-[#9146ff] hover:bg-[#772ce8] text-white px-8 py-3 font-bold transition">CONNETTI TWITCH</button>
            </div>
        </div>

    </main>

    <script>
        const CLIENT_ID = 'uqf5d6at2fnet8w5tylz17l2sb4onx';
        const REDIRECT_URI = 'https://serowsour.github.io/aabot/';
        
        let client;
        let myUser = null;
        let activeChan = "";
        let botCmds = JSON.parse(localStorage.getItem('win10_bot_cmds')) || {};

        async function login() {
            const scope = 'chat:read chat:edit channel:moderate user:read:email';
            window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(scope)}`;
        }

        function logout() {
            localStorage.removeItem('aa_token');
            location.href = REDIRECT_URI;
        }

        window.onload = async () => {
            const hash = window.location.hash;
            let token = localStorage.getItem('aa_token');

            if (hash) {
                token = new URLSearchParams(hash.substring(1)).get('access_token');
                localStorage.setItem('aa_token', token);
                window.history.pushState({}, document.title, window.location.pathname);
            }

            if (token) {
                document.getElementById('login-modal').classList.add('hidden');
                const user = await fetchUser(token);
                if(user) {
                    myUser = user;
                    showAccount(user);
                    const chan = prompt("Canale da moderare:");
                    if(chan) initBot(token, chan.toLowerCase());
                } else {
                    logout();
                }
            }
        };

        async function fetchUser(token) {
            try {
                const r = await fetch('https://api.twitch.tv/helix/users', {
                    headers: { 'Authorization': `Bearer ${token}`, 'Client-ID': CLIENT_ID }
                });
                const d = await r.json();
                return d.data[0];
            } catch { return null; }
        }

        function showAccount(u) {
            document.getElementById('account-area').classList.remove('hidden');
            document.getElementById('acc-pic').src = u.profile_image_url;
            document.getElementById('acc-name').innerText = u.display_name;
        }

        function initBot(token, chan) {
            activeChan = chan;
            document.getElementById('live-player').classList.remove('hidden');
            document.getElementById('welcome-msg').classList.add('hidden');
            document.getElementById('status-led').classList.replace('bg-red-600', 'bg-green-500');
            document.getElementById('status-text').innerText = "Live: " + chan;

            // Player
            document.getElementById('twitch-embed').innerHTML = `<iframe src="https://player.twitch.tv/?channel=${chan}&parent=serowsour.github.io" height="100%" width="100%" allowfullscreen="true"></iframe>`;

            client = new tmi.Client({
                identity: { username: myUser.login, password: `oauth:${token}` },
                channels: [chan]
            });

            client.connect();

            client.on('message', (channel, tags, message, self) => {
                const isMod = tags.mod || tags.badges?.broadcaster === '1';
                
                // Sblocca strumenti se sei mod
                if (tags.username === myUser.login && isMod) {
                    document.getElementById('mod-tools').classList.remove('hidden');
                }

                addChatMessage(tags, message, isMod);
                
                // Logica Bot
                const args = message.split(' ');
                if (args[0] === '!add' && isMod) {
                    botCmds[args[1]] = args.slice(2).join(' ');
                    localStorage.setItem('win10_bot_cmds', JSON.stringify(botCmds));
                    updateBotList();
                    client.say(chan, `‚úÖ Comando ${args[1]} salvato.`);
                }
                if (botCmds[args[0]]) client.say(chan, botCmds[args[0]]);
            });
        }

        function addChatMessage(tags, msg, isMod) {
            const chat = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = "chat-row flex items-start gap-2 group p-1 hover:bg-white/5 rounded";
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            div.innerHTML = `
                <span class="text-[10px] text-gray-600 mt-1">${time}</span>
                <div class="flex-1">
                    <span style="color:${tags.color || '#9146ff'}" class="font-bold">${tags['display-name']}</span>: 
                    <span class="text-gray-300">${msg}</span>
                </div>
                <div class="mod-btn flex gap-1">
                    <button onclick="quickMod('warn', '${tags.username}')" title="Warn" class="bg-yellow-600/20 text-yellow-500 px-1 rounded text-[10px]">‚ö†Ô∏è</button>
                    <button onclick="quickMod('delete', '${tags.id}')" title="Elimina" class="bg-red-600/20 text-red-500 px-1 rounded text-[10px]">üóëÔ∏è</button>
                    <button onclick="quickMod('timeout', '${tags.username}')" title="Timeout" class="bg-orange-600/20 text-orange-500 px-1 rounded text-[10px]">‚è≥</button>
                    <button onclick="quickMod('ban', '${tags.username}')" title="Ban" class="bg-red-900 text-white px-1 rounded text-[10px]">üö´</button>
                </div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function quickMod(action, target) {
            if(!client) return;
            if(action === 'warn') client.say(activeChan, `@${target} ‚ö†Ô∏è Questo √® un avvertimento ufficiale. Rispetta il regolamento!`);
            if(action === 'delete') client.deletemessage(activeChan, target);
            if(action === 'timeout') client.timeout(activeChan, target, 600, "Timeout rapido");
            if(action === 'ban') client.ban(activeChan, target, "Ban da console");
        }

        function modAction(cmd) { if(client) client.say(activeChan, cmd); }

        function toggleShield() {
            if(!client) return;
            client.say(activeChan, "/subsonly");
            client.say(activeChan, "/clear");
            alert("üõ°Ô∏è SHIELD ATTIVATO");
        }

        function updateBotList() {
            const list = document.getElementById('bot-list');
            list.innerHTML = Object.keys(botCmds).map(c => `<div class="bg-white/5 p-1 rounded border border-white/10 flex justify-between"><span>${c}</span><button onclick="delete botCmds['${c}']; localStorage.setItem('win10_bot_cmds', JSON.stringify(botCmds)); updateBotList()" class="text-red-500">√ó</button></div>`).join('');
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && client) {
                client.say(activeChan, e.target.value);
                e.target.value = '';
            }
        });

        updateBotList();
    </script>
</body>
</html>
