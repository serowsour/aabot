<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Win10 Mod Station</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #000; overflow: hidden; }
        .win-taskbar { background: rgba(16, 16, 16, 0.9); backdrop-filter: blur(10px); }
        .win-border { border: 1px solid #333; }
        .hidden { display: none !important; }
        /* Scrollbar stile Windows 10 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col text-white">

    <div class="h-10 win-taskbar border-b border-[#333] flex justify-between items-center px-4 z-50">
        <div class="flex items-center gap-4">
            <span class="text-purple-500 font-bold">AABOT OS</span>
            <div id="user-info" class="hidden flex items-center gap-2 border-l border-[#444] pl-4">
                <img id="user-avatar" src="" class="w-6 h-6 rounded-full border border-purple-500">
                <span id="user-name" class="text-xs font-semibold"></span>
                <button onclick="logout()" class="text-[10px] bg-red-900/40 hover:bg-red-600 px-2 py-0.5 rounded transition">LOGOUT</button>
            </div>
        </div>
        <div id="status-bar" class="text-[10px] uppercase tracking-widest text-gray-500 font-bold">Sistema Offline</div>
    </div>

    <div class="flex-1 flex overflow-hidden p-2 gap-2 bg-[#111]">
        
        <div id="login-screen" class="absolute inset-0 z-[100] bg-black/80 flex items-center justify-center backdrop-blur-md">
            <div class="bg-[#1f1f1f] p-8 win-border text-center shadow-2xl rounded-sm">
                <h2 class="text-2xl font-light mb-6">Benvenuto in <span class="text-purple-500">AA-Bot</span></h2>
                <button onclick="login()" class="bg-[#0078d7] hover:bg-[#198ce6] text-white px-10 py-3 font-semibold transition shadow-lg">
                    ACCEDI CON TWITCH
                </button>
            </div>
        </div>

        <div class="flex-[2] flex flex-col gap-2">
            <div id="stream-container" class="bg-black win-border aspect-video">
                <div id="twitch-embed" class="w-full h-full flex items-center justify-center text-gray-700 italic">
                    Inserisci un canale per vedere la stream
                </div>
            </div>
            <div class="flex-1 bg-[#181818] win-border flex flex-col overflow-hidden">
                <div class="p-2 bg-[#252525] text-[10px] font-bold border-b border-[#333] flex justify-between">
                    <span>LIVE CHAT MONITOR</span>
                    <span id="mod-indicator" class="text-red-500">MODALITÀ SOLA LETTURA</span>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 text-sm font-mono space-y-1"></div>
                <div class="p-2 bg-[#1f1f1f] border-t border-[#333]">
                    <input type="text" id="chat-input" placeholder="Messaggio..." class="w-full bg-[#333] border border-[#444] p-2 text-sm focus:outline-none focus:border-[#0078d7]">
                </div>
            </div>
        </div>

        <div id="mod-panel" class="w-80 flex flex-col gap-2">
            <div class="bg-[#252525] win-border p-4">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-4 tracking-tighter">Azioni Rapide</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="quickCmd('/clear')" class="bg-[#333] hover:bg-[#444] p-2 text-[10px] font-bold win-border uppercase">Clear</button>
                    <button onclick="quickCmd('/subsonly')" class="bg-[#333] hover:bg-[#444] p-2 text-[10px] font-bold win-border uppercase">Sub Only</button>
                    <button onclick="quickCmd('/emoteonly')" class="bg-[#333] hover:bg-[#444] p-2 text-[10px] font-bold win-border uppercase">Emote Only</button>
                    <button onclick="quickCmd('/slow 10')" class="bg-[#333] hover:bg-[#444] p-2 text-[10px] font-bold win-border uppercase">Slow 10s</button>
                </div>
            </div>

            <div class="bg-[#252525] win-border p-4 flex-1 overflow-hidden flex flex-col">
                <h3 class="text-xs font-bold text-red-500 uppercase mb-4 tracking-tighter">Protezione Shield</h3>
                <button onclick="activateShield()" class="w-full bg-red-700 hover:bg-red-600 p-4 font-bold text-sm mb-4">SHIELD MODE ON</button>
                
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-tighter">Comandi Bot</h3>
                <div id="bot-cmds" class="flex-1 overflow-y-auto space-y-2 text-xs text-purple-300 italic"></div>
                <div class="mt-2 text-[9px] text-gray-500 bg-black/20 p-2 border border-white/5">
                    Usa <span class="text-white">!add !nome testo</span> per aggiungere.
                </div>
            </div>
        </div>

    </div>

    <script>
        const CLIENT_ID = 'uqf5d6at2fnet8w5tylz17l2sb4onx';
        const REDIRECT_URI = 'https://serowsour.github.io/aabot/';
        
        let client;
        let userData = {};
        let currentChannel = '';
        let commands = JSON.parse(localStorage.getItem('aa_cmds')) || {};

        function login() {
            const scope = 'chat:read chat:edit channel:moderate user:read:email';
            window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(scope)}`;
        }

        function logout() {
            localStorage.removeItem('twitch_token');
            window.location.href = REDIRECT_URI;
        }

        window.onload = async () => {
            const hash = window.location.hash;
            let token = localStorage.getItem('twitch_token');

            if (hash) {
                token = new URLSearchParams(hash.substring(1)).get('access_token');
                localStorage.setItem('twitch_token', token);
                window.history.pushState({}, document.title, window.location.pathname);
            }

            if (token) {
                document.getElementById('login-screen').classList.add('hidden');
                await fetchUserData(token);
                const chan = prompt("A quale canale vuoi connetterti?");
                if(chan) initApp(token, chan.toLowerCase());
            }
        };

        async function fetchUserData(token) {
            const resp = await fetch('https://api.twitch.tv/helix/users', {
                headers: { 'Authorization': `Bearer ${token}`, 'Client-ID': CLIENT_ID }
            });
            const data = await resp.json();
            userData = data.data[0];
            
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('user-avatar').src = userData.profile_image_url;
            document.getElementById('user-name').innerText = userData.display_name;
        }

        function initApp(token, channel) {
            currentChannel = channel;
            
            // Embed Stream
            document.getElementById('twitch-embed').innerHTML = `<iframe src="https://player.twitch.tv/?channel=${channel}&parent=serowsour.github.io" height="100%" width="100%" allowfullscreen="true"></iframe>`;

            client = new tmi.Client({
                identity: { username: userData.login, password: `oauth:${token}` },
                channels: [channel]
            });

            client.connect().then(() => {
                document.getElementById('status-bar').innerText = `CONNESSO A: ${channel}`;
                document.getElementById('status-bar').classList.replace('text-gray-500', 'text-green-500');
            });

            client.on('message', (chan, tags, msg, self) => {
                // Riconoscimento Mod Automatico (Broadcaster o Mod)
                const isMod = tags.mod || tags.badges?.broadcaster === '1';
                
                // Se sono io (l'utente loggato) e sono mod, abilito il pannello
                if (tags.username === userData.login) {
                    if (isMod) {
                        document.getElementById('mod-panel').classList.remove('hidden');
                        document.getElementById('mod-indicator').innerText = "MODALITÀ MODERATORE ATTIVA";
                        document.getElementById('mod-indicator').classList.replace('text-red-500', 'text-green-500');
                    } else {
                        document.getElementById('mod-panel').classList.add('hidden');
                    }
                }

                renderChat(tags, msg);
                handleBot(tags, msg, isMod);
            });
        }

        function renderChat(tags, msg) {
            const box = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:${tags.color || '#9146ff'}"><strong>${tags['display-name']}</strong></span>: ${msg}`;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function handleBot(tags, msg, isMod) {
            const args = msg.split(' ');
            const cmd = args[0].toLowerCase();

            if (cmd === '!add' && isMod) {
                if(args[1] && args[2]) {
                    commands[args[1]] = args.slice(2).join(' ');
                    localStorage.setItem('aa_cmds', JSON.stringify(commands));
                    client.say(currentChannel, `✅ Comando ${args[1]} aggiunto.`);
                    updateCmdList();
                }
            }

            if (commands[cmd]) client.say(currentChannel, commands[cmd]);
        }

        function updateCmdList() {
            const list = document.getElementById('bot-cmds');
            list.innerHTML = Object.keys(commands).map(c => `<div>${c}</div>`).join('');
        }

        function quickCmd(cmd) {
            if(client) client.say(currentChannel, cmd);
        }

        function activateShield() {
            if(!client) return;
            client.say(currentChannel, "/clear");
            client.say(currentChannel, "/subsonly");
            client.say(currentChannel, "/slow 10");
            alert("⚠️ SHIELD ATTIVATO: Chat protetta.");
        }

        // Input Invio
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter' && client) {
                client.say(currentChannel, e.target.value);
                e.target.value = '';
            }
        });
        
        updateCmdList();
    </script>
</body>
</html>
