<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AA-BOT Moderazione</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
</head>
<body class="bg-[#0e0e10] text-white font-sans p-4 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-5xl bg-[#18181b] rounded-lg border border-[#2f2f35] flex flex-col h-[85vh] shadow-2xl overflow-hidden">
        
        <div class="p-4 border-b border-[#2f2f35] flex justify-between items-center bg-[#1f1f23]">
            <div class="flex items-center gap-2">
                <div id="status-led" class="w-3 h-3 bg-red-600 rounded-full"></div>
                <h1 class="font-black text-sm tracking-widest uppercase">AA-BOT MODERATOR</h1>
            </div>
            <button onclick="startLogin()" id="authBtn" class="bg-[#9146ff] hover:bg-[#772ce8] px-4 py-2 rounded text-xs font-bold transition">
                COLLEGA TWITCH
            </button>
        </div>

        <div class="flex flex-1 overflow-hidden">
            <div class="flex-1 flex flex-col p-4 border-r border-[#2f2f35]">
                <div id="chat-stream" class="flex-1 overflow-y-auto space-y-1 text-sm font-mono p-2 bg-black/20 rounded">
                    <p class="text-gray-600">// Sistema pronto. Clicca su Collega Twitch.</p>
                </div>
                
                <div class="mt-4 flex gap-2">
                    <button onclick="quickAction('/subsonly')" class="flex-1 bg-red-900/30 border border-red-600 text-red-500 p-2 rounded text-[10px] font-bold uppercase hover:bg-red-600 hover:text-white transition">Anti-Raid ON</button>
                    <button onclick="quickAction('/subsonlyoff')" class="flex-1 bg-slate-800 border border-slate-600 p-2 rounded text-[10px] font-bold uppercase">Anti-Raid OFF</button>
                    <button onclick="quickAction('/clear')" class="flex-1 bg-slate-800 border border-slate-600 p-2 rounded text-[10px] font-bold uppercase">Svuota Chat</button>
                </div>
            </div>

            <div class="w-72 bg-[#1f1f23] p-4 flex flex-col">
                <h3 class="text-[10px] font-bold text-gray-500 uppercase mb-4 tracking-widest border-b border-gray-800 pb-2">Comandi Salvati</h3>
                <div id="cmd-list" class="flex-1 overflow-y-auto space-y-2">
                    </div>
                <div class="mt-4 text-[9px] text-gray-500 italic bg-black/20 p-2 rounded">
                    Usa <span class="text-purple-400">!add !comando testo</span> in chat per aggiungere risposte automatiche.
                </div>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = 'uqf5d6at2fnet8w5tylz17l2sb4onx';
        const REDIRECT_URI = 'https://serowsour.github.io/aabot/';
        
        let client;
        let dynamicCommands = JSON.parse(localStorage.getItem('aaBot_cmds')) || {};

        // Inizio Login
        function startLogin() {
            const scope = encodeURIComponent('chat:read chat:edit channel:moderate');
            window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=${scope}`;
        }

        // Controllo se sono tornato dal login
        window.onload = () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    const channel = prompt("Inserisci il nome del tuo canale Twitch:");
                    if(channel) connectToTwitch(token, channel.toLowerCase());
                }
            }
            updateCmdUI();
        };

        function connectToTwitch(token, channel) {
            client = new tmi.Client({
                identity: { username: channel, password: `oauth:${token}` },
                channels: [channel]
            });

            client.connect().then(() => {
                document.getElementById('status-led').classList.replace('bg-red-600', 'bg-green-500');
                document.getElementById('authBtn').innerText = `CANALE: ${channel.toUpperCase()}`;
                document.getElementById('authBtn').classList.add('opacity-50', 'pointer-events-none');
                addLog(`Connesso a ${channel}`);
            }).catch(console.error);

            client.on('message', (chan, tags, message, self) => {
                if (self) return;
                
                displayMessage(tags['display-name'], message, tags.color);

                const isMod = tags.mod || tags['badges-raw']?.includes('broadcaster');
                const args = message.split(' ');
                const cmd = args[0].toLowerCase();

                // Comando !add !comando testo
                if (cmd === '!add' && isMod) {
                    const newCmd = args[1];
                    const reply = args.slice(2).join(' ');
                    if (newCmd && newCmd.startsWith('!') && reply) {
                        dynamicCommands[newCmd] = reply;
                        localStorage.setItem('aaBot_cmds', JSON.stringify(dynamicCommands));
                        updateCmdUI();
                        client.say(chan, `âœ… Comando ${newCmd} aggiunto!`);
                    }
                }

                // Esecuzione comandi
                if (dynamicCommands[cmd]) {
                    client.say(chan, dynamicCommands[cmd]);
                }
            });
        }

        function displayMessage(user, msg, color) {
            const stream = document.getElementById('chat-stream');
            const div = document.createElement('div');
            div.innerHTML = `<span style="color:${color || '#9146ff'}"><strong>${user}:</strong></span> ${msg}`;
            stream.appendChild(div);
            stream.scrollTop = stream.scrollHeight;
        }

        function addLog(text) {
            const stream = document.getElementById('chat-stream');
            stream.innerHTML += `<p class="text-yellow-500 italic">// ${text}</p>`;
        }

        function updateCmdUI() {
            const list = document.getElementById('cmd-list');
            list.innerHTML = Object.keys(dynamicCommands).map(c => 
                `<div class="bg-black/40 p-2 rounded flex justify-between items-center border border-gray-800">
                    <span class="text-xs font-bold text-purple-400">${c}</span>
                    <button onclick="deleteCmd('${c}')" class="text-[8px] text-red-500 hover:text-white">ELIMINA</button>
                </div>`
            ).join('');
        }

        function deleteCmd(cmd) {
            delete dynamicCommands[cmd];
            localStorage.setItem('aaBot_cmds', JSON.stringify(dynamicCommands));
            updateCmdUI();
        }

        function quickAction(cmd) {
            if (client) {
                client.say(client.getChannels()[0], cmd);
            } else {
                alert("Collega Twitch prima!");
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #2f2f35; border-radius: 10px; }
        #chat-stream div { border-bottom: 1px solid rgba(255,255,255,0.03); padding: 2px 0; }
    </style>
</body>
</html>
