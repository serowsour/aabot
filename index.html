<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 10 Moderator Pro Station - AA-BOT</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --win-bg: #1f1f1f;
            --win-taskbar: #171717;
            --win-accent: #0078d7;
            --win-border: #333333;
            --win-hover: #323232;
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #000;
            color: #ffffff;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            margin: 0;
            user-select: none;
        }

        /* --- Scrollbar Stile Windows 10 --- */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border: 2px solid #111; }
        ::-webkit-scrollbar-thumb:hover { background: #666; }

        /* --- Animazioni --- */
        @keyframes windowOpen {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .app-window { animation: windowOpen 0.2s ease-out; }

        /* --- UI Components --- */
        .win-btn {
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .win-btn:hover {
            background-color: var(--win-hover);
            border-color: #454545;
        }
        .win-input {
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }
        .win-input:focus { border-color: var(--win-accent); }

        .chat-row { border-left: 2px solid transparent; transition: background 0.1s; }
        .chat-row:hover { background: rgba(255,255,255,0.05); border-left-color: var(--win-accent); }

        .mod-actions-inline { display: none; }
        .chat-row:hover .mod-actions-inline { display: flex; }

        /* Taskbar icons */
        .taskbar-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        .taskbar-icon:hover { background: rgba(255,255,255,0.1); }
        .taskbar-icon.active { border-bottom: 2px solid var(--win-accent); background: rgba(255,255,255,0.05); }

        /* Glassmorphism */
        .glass { background: rgba(31, 31, 31, 0.85); backdrop-filter: blur(15px); }

        /* Player Aspect Ratio */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }
        
        #login-overlay {
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        }
    </style>
</head>
<body>

    <div id="login-overlay" class="fixed inset-0 z-[999] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="mb-8 flex flex-col items-center">
            <div class="w-20 h-20 bg-purple-600 rounded-xl flex items-center justify-center shadow-2xl mb-4">
                <span class="text-4xl font-bold">AA</span>
            </div>
            <h1 class="text-4xl font-light tracking-tight">Windows 10 <span class="font-bold">Mod Station</span></h1>
            <p class="text-gray-500 mt-2 font-mono text-sm uppercase tracking-widest">Version 2026.1 Build 600</p>
        </div>
        <button onclick="TwitchAuth.login()" class="bg-[#9146ff] hover:bg-[#772ce8] text-white px-12 py-4 rounded font-bold text-lg shadow-xl transition-transform active:scale-95">
            CONNETTI ACCOUNT TWITCH
        </button>
        <div class="mt-12 text-gray-600 text-[10px] uppercase font-bold tracking-tighter">Powered by TMI.js & Helix API</div>
    </div>

    <div id="desktop" class="h-screen w-screen flex flex-col hidden">
        
        <header class="h-10 bg-[#171717] border-b border-[#333] flex justify-between items-center px-4">
            <div class="flex items-center gap-6 h-full">
                <div class="flex items-center gap-2">
                    <span class="text-blue-500 text-lg">ü™ü</span>
                    <span class="text-xs font-semibold tracking-tighter uppercase">Moderator Pro</span>
                </div>
                <div id="user-display" class="flex items-center gap-2 border-l border-white/10 pl-4 h-6">
                    <img id="user-avatar" src="" class="w-5 h-5 rounded-full border border-blue-500">
                    <span id="user-name" class="text-[11px] font-bold">---</span>
                    <button onclick="TwitchAuth.logout()" class="text-[9px] text-red-500 hover:text-red-400 font-black ml-2 uppercase">Logout</button>
                </div>
            </div>
            <div class="flex items-center gap-4 text-[10px] font-mono">
                <div class="flex items-center gap-2">
                    <div id="conn-led" class="w-2 h-2 rounded-full bg-red-600 shadow-[0_0_5px_red]"></div>
                    <span id="conn-status" class="text-gray-400 uppercase">Sconnesso</span>
                </div>
                <div id="clock" class="text-gray-200 tabular-nums">00:00:00</div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden bg-[#0a0a0a] p-2 gap-2">
            
            <nav class="w-12 flex flex-col gap-2 items-center py-2 bg-[#171717] border border-[#333]">
                <div class="taskbar-icon active" title="DASHBOARD"><span class="text-lg">üè†</span></div>
                <div class="taskbar-icon" title="SHIELD MODE" onclick="ModActions.shieldToggle()"><span class="text-lg text-red-500">üõ°Ô∏è</span></div>
                <div class="taskbar-icon" title="STATISTICHE"><span class="text-lg">üìä</span></div>
                <div class="mt-auto taskbar-icon" title="IMPOSTAZIONI"><span class="text-lg text-gray-500">‚öôÔ∏è</span></div>
            </nav>

            <div class="flex-1 grid grid-cols-12 grid-rows-6 gap-2">
                
                <div class="col-span-8 row-span-3 bg-[#111] border border-[#333] overflow-hidden flex flex-col">
                    <div class="h-8 bg-[#222] border-b border-[#333] flex items-center px-3 justify-between">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">Monitor Live Stream</span>
                        <div id="live-indicator" class="hidden flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-600 rounded-full animate-pulse"></span>
                            <span class="text-[9px] font-bold text-red-500 uppercase">Live</span>
                        </div>
                    </div>
                    <div id="player-area" class="flex-1 bg-black relative">
                        <div id="twitch-player-container" class="w-full h-full flex flex-col items-center justify-center">
                            <p class="text-gray-700 italic text-sm">Seleziona un canale per avviare il monitoraggio video...</p>
                        </div>
                    </div>
                </div>

                <div class="col-span-4 row-span-6 bg-[#111] border border-[#333] flex flex-col overflow-hidden">
                    <div class="h-8 bg-[#222] border-b border-[#333] flex items-center px-3 justify-between">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">Chat Console</span>
                        <span id="channel-target-label" class="text-[10px] text-blue-500 font-bold uppercase">Nessun Canale</span>
                    </div>
                    
                    <div id="chat-stream" class="flex-1 overflow-y-auto p-3 space-y-3 font-medium text-[13px] leading-relaxed select-text">
                        </div>

                    <div class="p-3 bg-[#171717] border-t border-[#333] space-y-2">
                        <div class="flex gap-2">
                            <input type="text" id="chat-input" placeholder="Invia messaggio..." class="win-input flex-1">
                            <button onclick="ChatController.sendMsg()" class="bg-blue-600 hover:bg-blue-500 px-4 text-xs font-bold uppercase">Invia</button>
                        </div>
                    </div>
                </div>

                <div class="col-span-8 row-span-3 grid grid-cols-3 gap-2">
                    
                    <div class="bg-[#171717] border border-[#333] p-4 flex flex-col">
                        <h3 class="text-[10px] font-black text-gray-500 uppercase border-b border-white/5 pb-2 mb-4">Azioni Rapide Canale</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="ModActions.exec('/clear')" class="win-btn py-3 text-[10px] font-bold uppercase bg-[#252525]">Clear</button>
                            <button onclick="ModActions.exec('/subsonly')" class="win-btn py-3 text-[10px] font-bold uppercase bg-[#252525]">Subs Only</button>
                            <button onclick="ModActions.exec('/emoteonly')" class="win-btn py-3 text-[10px] font-bold uppercase bg-[#252525]">Emote Only</button>
                            <button onclick="ModActions.exec('/slow 10')" class="win-btn py-3 text-[10px] font-bold uppercase bg-[#252525]">Slow (10s)</button>
                            <button onclick="ModActions.exec('/subsonlyoff')" class="win-btn py-2 text-[9px] font-bold uppercase bg-[#111] text-gray-400">Subs OFF</button>
                            <button onclick="ModActions.exec('/emoteonlyoff')" class="win-btn py-2 text-[9px] font-bold uppercase bg-[#111] text-gray-400">Emote OFF</button>
                        </div>
                    </div>

                    <div class="bg-[#171717] border border-[#333] p-4 flex flex-col col-span-2 overflow-hidden">
                        <div class="flex justify-between items-center border-b border-white/5 pb-2 mb-4">
                            <h3 class="text-[10px] font-black text-blue-500 uppercase">Comandi Personalizzati Bot</h3>
                            <span class="text-[9px] text-gray-600 italic">!add !comando risposta</span>
                        </div>
                        <div id="bot-commands-list" class="flex-1 overflow-y-auto grid grid-cols-2 gap-2 content-start">
                            </div>
                    </div>

                </div>

            </div>
        </div>

        <footer class="h-6 bg-blue-600 flex justify-between items-center px-4 text-[10px] font-bold uppercase tracking-widest">
            <div class="flex gap-4">
                <span>System Status: Optimal</span>
                <span id="mod-mode-label">Mode: Read Only</span>
            </div>
            <div id="uptime-label">Uptime: 00:00:00</div>
        </footer>

    </div>

    <script>
        /** * GLOBAL CONFIGURATION 
         */
        const CONFIG = {
            CLIENT_ID: 'uqf5d6at2fnet8w5tylz17l2sb4onx',
            REDIRECT_URI: 'https://serowsour.github.io/aabot/',
            SCOPES: 'chat:read chat:edit channel:moderate user:read:email',
            PARENT_DOMAIN: 'serowsour.github.io'
        };

        /** * STATE MANAGEMENT 
         */
        let state = {
            token: localStorage.getItem('aa_mod_token'),
            user: null,
            channel: null,
            client: null,
            startTime: Date.now(),
            commands: JSON.parse(localStorage.getItem('aa_bot_cmds')) || {}
        };

        /**
         * TWITCH AUTHENTICATION SERVICE
         */
        const TwitchAuth = {
            login() {
                const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CONFIG.CLIENT_ID}&redirect_uri=${encodeURIComponent(CONFIG.REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(CONFIG.SCOPES)}`;
                window.location.href = url;
            },

            logout() {
                localStorage.removeItem('aa_mod_token');
                window.location.href = CONFIG.REDIRECT_URI;
            },

            async handleCallback() {
                const hash = window.location.hash;
                if (hash.includes('access_token')) {
                    const params = new URLSearchParams(hash.substring(1));
                    state.token = params.get('access_token');
                    localStorage.setItem('aa_mod_token', state.token);
                    window.history.pushState({}, document.title, window.location.pathname);
                }

                if (state.token) {
                    const userData = await this.validateToken();
                    if (userData) {
                        state.user = userData;
                        UI.initDesktop();
                        this.promptChannel();
                    } else {
                        this.logout();
                    }
                }
            },

            async validateToken() {
                try {
                    const response = await fetch('https://api.twitch.tv/helix/users', {
                        headers: {
                            'Authorization': `Bearer ${state.token}`,
                            'Client-ID': CONFIG.CLIENT_ID
                        }
                    });
                    const data = await response.json();
                    return data.data ? data.data[0] : null;
                } catch (e) {
                    console.error("Token validation failed", e);
                    return null;
                }
            },

            promptChannel() {
                const chan = prompt("Inserisci il nome del canale Twitch da moderare (tutto minuscolo):");
                if (chan) {
                    state.channel = chan.toLowerCase().trim();
                    ChatController.connect();
                    UI.initPlayer();
                } else {
                    alert("Canale necessario per procedere.");
                    this.promptChannel();
                }
            }
        };

        /**
         * CHAT & TMI.JS CONTROLLER
         */
        const ChatController = {
            connect() {
                UI.updateStatus('Connessione...', 'bg-yellow-500');

                state.client = new tmi.Client({
                    options: { debug: false },
                    connection: { reconnect: true, secure: true },
                    identity: {
                        username: state.user.login,
                        password: `oauth:${state.token}`
                    },
                    channels: [state.channel]
                });

                state.client.connect().then(() => {
                    UI.updateStatus('Live', 'bg-green-500');
                    UI.addSystemMsg(`Sincronizzazione completata su #${state.channel}`);
                    document.getElementById('channel-target-label').innerText = `#${state.channel}`;
                }).catch(err => {
                    UI.updateStatus('Errore', 'bg-red-600');
                    UI.addSystemMsg(`Errore critico: ${err}`);
                });

                this.registerEvents();
            },

            registerEvents() {
                state.client.on('message', (chan, tags, message, self) => {
                    this.handleIncoming(tags, message, self);
                });

                state.client.on('messagedeleted', (chan, user, msg, tags) => {
                    UI.addSystemMsg(`Messaggio rimosso: ${user}`);
                });

                state.client.on('ban', (chan, user, reason) => {
                    UI.addSystemMsg(`UTENTE BANNATO: ${user}`);
                });
            },

            handleIncoming(tags, message, self) {
                const isMod = tags.mod || tags.badges?.broadcaster === '1';
                
                // Aggiorna permessi UI se il mio utente loggato √® mod
                if (tags.username === state.user.login) {
                    UI.updateModMode(isMod);
                }

                // Renderizza messaggio
                UI.renderChatMessage(tags, message);

                // Logica Bot Comandi
                const args = message.split(' ');
                const cmd = args[0].toLowerCase();

                if (cmd === '!add' && isMod) {
                    if (args[1] && args[2]) {
                        state.commands[args[1]] = args.slice(2).join(' ');
                        localStorage.setItem('aa_bot_cmds', JSON.stringify(state.commands));
                        UI.renderBotCmds();
                        state.client.say(state.channel, `üíæ Comando ${args[1]} registrato.`);
                    }
                }

                if (state.commands[cmd]) {
                    state.client.say(state.channel, state.commands[cmd]);
                }
            },

            sendMsg() {
                const input = document.getElementById('chat-input');
                if (input.value && state.client) {
                    state.client.say(state.channel, input.value);
                    input.value = '';
                }
            }
        };

        /**
         * UI & RENDERING ENGINE
         */
        const UI = {
            initDesktop() {
                document.getElementById('login-overlay').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('login-overlay').classList.add('hidden');
                    document.getElementById('desktop').classList.remove('hidden');
                }, 500);

                document.getElementById('user-avatar').src = state.user.profile_image_url;
                document.getElementById('user-name').innerText = state.user.display_name;
                
                this.renderBotCmds();
                this.startClock();
            },

            initPlayer() {
                const playerArea = document.getElementById('twitch-player-container');
                playerArea.innerHTML = `
                    <div class="video-container">
                        <iframe 
                            src="https://player.twitch.tv/?channel=${state.channel}&parent=${CONFIG.PARENT_DOMAIN}&autoplay=true" 
                            allowfullscreen="true">
                        </iframe>
                    </div>
                `;
                document.getElementById('live-indicator').classList.remove('hidden');
            },

            updateStatus(text, colorClass) {
                const led = document.getElementById('conn-led');
                const label = document.getElementById('conn-status');
                led.className = `w-2 h-2 rounded-full ${colorClass}`;
                label.innerText = text;
            },

            updateModMode(isMod) {
                const label = document.getElementById('mod-mode-label');
                label.innerText = isMod ? "Mode: Full Moderator" : "Mode: Read Only (Not Mod)";
                label.className = isMod ? "text-green-400" : "text-yellow-500";
            },

            renderChatMessage(tags, message) {
                const stream = document.getElementById('chat-stream');
                const row = document.createElement('div');
                row.className = "chat-row flex flex-col p-1 rounded relative";
                
                const badges = this.generateBadges(tags);
                const color = tags.color || '#0078d7';

                row.innerHTML = `
                    <div class="flex items-center gap-1 mb-0.5">
                        <span class="text-[9px] text-gray-600 font-mono">${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                        ${badges}
                        <span style="color:${color}" class="font-bold cursor-pointer" onclick="UI.insertMention('${tags.username}')">${tags['display-name']}</span>
                        
                        <div class="mod-actions-inline ml-auto flex gap-1">
                            <button onclick="ModActions.warn('${tags.username}')" class="bg-yellow-600/20 text-yellow-500 px-1 rounded text-[9px] font-bold">WARN</button>
                            <button onclick="ModActions.exec('/delete ${tags.id}')" class="bg-red-600/20 text-red-500 px-1 rounded text-[9px] font-bold">DEL</button>
                            <button onclick="ModActions.exec('/timeout ${tags.username} 600')" class="bg-orange-600/20 text-orange-500 px-1 rounded text-[9px] font-bold">10M</button>
                            <button onclick="ModActions.exec('/ban ${tags.username}')" class="bg-red-600 text-white px-1 rounded text-[9px] font-bold">BAN</button>
                        </div>
                    </div>
                    <div class="text-gray-200 pl-8 break-words">${message}</div>
                `;
                
                stream.appendChild(row);
                stream.scrollTop = stream.scrollHeight;
            },

            generateBadges(tags) {
                let html = '';
                if (tags.badges?.broadcaster) html += '<span class="bg-red-600 text-[8px] px-1 rounded text-white font-black">STRE</span>';
                if (tags.mod) html += '<span class="bg-green-600 text-[8px] px-1 rounded text-white font-black">MOD</span>';
                if (tags.subscriber) html += '<span class="bg-purple-600 text-[8px] px-1 rounded text-white font-black">SUB</span>';
                return html;
            },

            addSystemMsg(text) {
                const stream = document.getElementById('chat-stream');
                stream.innerHTML += `
                    <div class="py-1 text-[10px] text-blue-400 font-mono italic opacity-70">
                        [SYSTEM] >> ${text}
                    </div>
                `;
                stream.scrollTop = stream.scrollHeight;
            },

            insertMention(user) {
                const input = document.getElementById('chat-input');
                input.value = `@${user} ` + input.value;
                input.focus();
            },

            renderBotCmds() {
                const list = document.getElementById('bot-commands-list');
                list.innerHTML = '';
                Object.keys(state.commands).forEach(key => {
                    const item = document.createElement('div');
                    item.className = "flex justify-between items-center bg-[#252525] p-2 border border-white/5 group";
                    item.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-blue-400 font-bold">${key}</span>
                            <span class="text-[9px] text-gray-500 truncate w-32">${state.commands[key]}</span>
                        </div>
                        <button onclick="UI.removeCmd('${key}')" class="text-red-500 opacity-0 group-hover:opacity-100 font-bold">‚úï</button>
                    `;
                    list.appendChild(item);
                });
            },

            removeCmd(key) {
                delete state.commands[key];
                localStorage.setItem('aa_bot_cmds', JSON.stringify(state.commands));
                this.renderBotCmds();
            },

            startClock() {
                setInterval(() => {
                    document.getElementById('clock').innerText = new Date().toLocaleTimeString();
                    const diff = Math.floor((Date.now() - state.startTime) / 1000);
                    const h = Math.floor(diff / 3600).toString().padStart(2,'0');
                    const m = Math.floor((diff % 3600) / 60).toString().padStart(2,'0');
                    const s = (diff % 60).toString().padStart(2,'0');
                    document.getElementById('uptime-label').innerText = `Uptime: ${h}:${m}:${s}`;
                }, 1000);
            }
        };

        /**
         * MODERATION ACTIONS
         */
        const ModActions = {
            exec(cmd) {
                if (state.client) {
                    state.client.say(state.channel, cmd);
                }
            },

            warn(user) {
                this.exec(`@${user} >> AVVISO: Il tuo comportamento viola il regolamento del canale. Sei pregato di smettere immediatamente. ‚ö†Ô∏è`);
            },

            shieldToggle() {
                const btn = document.querySelector('[title="SHIELD MODE"]');
                const isActive = btn.classList.contains('bg-red-600/20');
                
                if (!isActive) {
                    btn.classList.add('bg-red-600/20', 'border-red-600');
                    this.exec('/subsonly');
                    this.exec('/slow 15');
                    this.exec('/clear');
                    UI.addSystemMsg("MODALIT√Ä SCUDO ATTIVATA: Restrizioni massime applicate.");
                } else {
                    btn.classList.remove('bg-red-600/20', 'border-red-600');
                    this.exec('/subsonlyoff');
                    this.exec('/slowoff');
                    UI.addSystemMsg("MODALIT√Ä SCUDO DISATTIVATA.");
                }
            }
        };

        // Inizializzazione
        TwitchAuth.handleCallback();

        // Listener per tasto invio nell'input
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') ChatController.sendMsg();
        });

    </script>
</body>
</html>
